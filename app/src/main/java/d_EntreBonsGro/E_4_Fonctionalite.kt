package d_EntreBonsGro

import a_RoomDB.BaseDonne
import com.google.firebase.database.DatabaseReference
import f_credits.SupplierTabelle
import kotlinx.coroutines.CoroutineScope
import java.time.LocalDate
import kotlin.math.roundToInt

fun updateSpecificArticle(input: String, article: EntreBonsGrosTabele, articlesRef: DatabaseReference, coroutineScope: CoroutineScope): Boolean {
    val regex = """(\d+)\s*[x+]\s*(\d+(\.\d+)?)""".toRegex()
    val matchResult = regex.find(input)

    val (quantity, price) = matchResult?.destructured?.let {
        Pair(it.component1().toIntOrNull(), it.component2().toDoubleOrNull())
    } ?: Pair(null, null)

    if (quantity != null && price != null) {
        val updatedArticle = article.copy(
            quantityAcheteBG = quantity,
            newPrixAchatBG = price,
            subTotaleBG = price * quantity
        )
        articlesRef.child(article.vidBG.toString()).setValue(updatedArticle)



        return true
    }
    return false
}


fun processInputAndInsertData(
    input: String,
    articlesList: List<EntreBonsGrosTabele>,
    articlesRef: DatabaseReference,
    founisseurNowIs: Int?,
    articlesBaseDonne: List<BaseDonne>,
    suppliersList: List<SupplierTabelle>
): Long? {
    val regex = """(\d+)\s*[x+]\s*(\d+(\.\d+)?)""".toRegex()
    val matchResult = regex.find(input)

    val (quantity, price) = matchResult?.destructured?.let {
        Pair(it.component1().toIntOrNull(), it.component2().toDoubleOrNull())
    } ?: Pair(null, null)

    if (quantity != null && price != null) {
        val newVid = (articlesList.maxOfOrNull { it.vidBG } ?: 0) + 1
        var quantityUniterBG = 1

        val baseDonneEntry = articlesBaseDonne.find { it.idArticle.toLong() == newVid }
        if (baseDonneEntry != null) {
            quantityUniterBG = baseDonneEntry.nmbrUnite.toInt()
        }

        val supplier = suppliersList.find { it.bonDuSupplierSu == founisseurNowIs?.toString() }
        val currentDate = LocalDate.now().toString()

        val newArticle = supplier?.idSupplierSu?.let {
            EntreBonsGrosTabele(
                vidBG = newVid,
                idArticleBG = 0,
                nomArticleBG = "",
                ancienPrixBG = 0.0,
                newPrixAchatBG = price,
                quantityAcheteBG = quantity,
                quantityUniterBG = quantityUniterBG,
                subTotaleBG = price * quantity,
                grossisstBonN = founisseurNowIs ?: 0,
                supplierIdBG = it,
                supplierNameBG = supplier.nomSupplierSu ,
                uniterCLePlusUtilise = false,
                erreurCommentaireBG = "",
                passeToEndStateBG = false,
                dateCreationBG = currentDate
            )
        }
        articlesRef.child(newVid.toString()).setValue(newArticle)
            .addOnSuccessListener {
                println("New article inserted successfully")
            }
            .addOnFailureListener { e ->
                println("Error inserting new article: ${e.message}")
            }

        return newVid
    }

    return null
}


fun Double.roundToTwoDecimals() = (this * 100).roundToInt() / 100.0